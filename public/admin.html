<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin â€” Device Manager</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0d0b14;color:#fff;padding:20px}
  .card{background:#14121a;padding:16px;border-radius:8px;max-width:980px;margin:12px auto}
  h1{margin:0 0 8px 0;color:#cbb9ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input[type=text]{padding:8px;border-radius:6px;border:1px solid #222;background:#0d0b14;color:#fff}
  button{padding:8px 10px;border-radius:6px;border:none;background:#7e22ce;color:#fff;cursor:pointer}
  button.ghost{background:#333;color:#fff}
  .device{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;margin:8px 0;background:#0f0d14}
  .device.revoked{background:rgba(255,0,0,0.06);border:1px solid rgba(255,0,0,0.12)}
  .device.active{background:rgba(0,255,0,0.03);border:1px solid rgba(0,255,0,0.06)}
  .note{font-size:13px;color:#aaa;margin-top:8px}
  #loginBox{max-width:360px;margin:14px auto;padding:16px;background:#140f22;border-radius:8px}
  label{font-size:13px;color:#ddd;margin-right:6px}
</style>
</head>
<body>

<div id="loginBox" class="card">
  <h1>Admin Login</h1>
  <div class="row">
    <input id="user" placeholder="username" type="text" />
    <input id="pass" placeholder="password" type="password" />
    <button id="loginBtn">Login</button>
  </div>
  <p class="note">Admin credentials (client-side): <strong>lukas / lukas</strong></p>
  <p id="loginMsg" class="note"></p>
</div>

<div id="ui" style="display:none">
  <div class="card">
    <h1>Device Manager</h1>

    <div style="display:flex;gap:12px;flex-wrap:wrap;">
      <div>
        <button id="fetchRemote" class="ghost">Fetch /logins.json (apply remote revokes)</button>
      </div>
      <div>
        <label for="fileInput">Import local JSON:</label>
        <input id="fileInput" type="file" accept=".json" />
      </div>
      <div>
        <button id="exportBtn">Export current revoked list (download)</button>
      </div>
    </div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #222" />

    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input id="manualId" type="text" placeholder="device id (eg dev-ab12cd34)" style="min-width:280px"/>
      <button id="revokeBtn">Revoke</button>
      <button id="unrevokeBtn" class="ghost">Unrevoke</button>
    </div>

    <p class="note">Known devices are read from <code>localStorage</code> key <code>allDevices</code> (devices created by your site on any browser where visited). If a device isn't listed, that device hasn't visited yet.</p>

    <div id="devicesList" style="margin-top:12px"></div>
  </div>
</div>

<script>
(() => {
  const ADMIN_USER = 'lukas', ADMIN_PASS = 'lukas';
  const REVOKE_KEY = 'revokedDevices_from_remote'; // local key we will use to store current revoked array
  const ALL_DEVICES_KEY = 'allDevices';

  // LOGIN
  const loginBox = document.getElementById('loginBox');
  const ui = document.getElementById('ui');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');

  function showUi() {
    loginBox.style.display = 'none';
    ui.style.display = 'block';
    renderDevices();
  }

  loginBtn.onclick = () => {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;
    if (u === ADMIN_USER && p === ADMIN_PASS) {
      localStorage.setItem('isAdmin', 'true');
      showUi();
    } else {
      loginMsg.textContent = 'Invalid credentials';
    }
  };

  // auto-login if remembered
  if (localStorage.getItem('isAdmin') === 'true') showUi();

  // Helpers
  function readRevokedLocal() {
    try { return JSON.parse(localStorage.getItem(REVOKE_KEY) || '[]'); } catch(e){ return []; }
  }
  function writeRevokedLocal(list) {
    try { localStorage.setItem(REVOKE_KEY, JSON.stringify(list)); } catch(e){}
  }

  function readAllDevices() {
    try { return JSON.parse(localStorage.getItem(ALL_DEVICES_KEY) || '[]'); } catch(e){ return []; }
  }

  // Apply remote JSON structure -> expects { "revoked": ["dev-..."] }
  async function fetchAndApplyRemote() {
    try {
      const res = await fetch('/logins.json', {cache: 'no-store'});
      if (!res.ok) throw new Error('Fetch failed: ' + res.status);
      const data = await res.json();
      if (!Array.isArray(data.revoked)) throw new Error('Invalid JSON format: missing revoked array');
      writeRevokedLocal(data.revoked);
      alert('Imported remote revoked list (' + data.revoked.length + ' ids). Applied locally.');
      renderDevices();
    } catch (err) {
      alert('Error fetching /logins.json: ' + err.message);
      console.error(err);
    }
  }

  document.getElementById('fetchRemote').onclick = fetchAndApplyRemote;

  // Import local file (so you can prepare a JSON on your desktop and import it)
  document.getElementById('fileInput').addEventListener('change', (ev) => {
    const f = ev.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(r.result);
        if (!Array.isArray(data.revoked)) {
          alert('Invalid JSON: expected {"revoked": ["dev-..."]}');
          return;
        }
        writeRevokedLocal(data.revoked);
        alert('Imported file and applied ' + data.revoked.length + ' revoked ids locally.');
        renderDevices();
      } catch (e) {
        alert('Invalid JSON file: ' + e.message);
      }
    };
    r.readAsText(f);
  });

  // Manual revoke/unrevoke
  document.getElementById('revokeBtn').onclick = () => {
    const id = document.getElementById('manualId').value.trim();
    if (!id) return alert('Enter device id');
    let arr = readRevokedLocal();
    if (!arr.includes(id)) arr.push(id);
    writeRevokedLocal(arr);
    alert('Revoked locally: ' + id);
    renderDevices();
  };
  document.getElementById('unrevokeBtn').onclick = () => {
    const id = document.getElementById('manualId').value.trim();
    if (!id) return alert('Enter device id');
    let arr = readRevokedLocal();
    arr = arr.filter(x => x !== id);
    writeRevokedLocal(arr);
    alert('Unrevoked locally: ' + id);
    renderDevices();
  };

  // Export current revoked list to JSON file (download)
  document.getElementById('exportBtn').onclick = () => {
    const arr = readRevokedLocal();
    const blob = new Blob([JSON.stringify({revoked: arr}, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'logins.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  // Render list of devices (reads allDevices local list, plus shows status from revoked list)
  function renderDevices() {
    const container = document.getElementById('devicesList');
    const allDevices = readAllDevices();
    const revoked = readRevokedLocal();
    container.innerHTML = '';
    if (allDevices.length === 0) {
      container.innerHTML = '<p class="note">No devices have visited yet (allDevices is empty).</p>';
      return;
    }
    allDevices.forEach(id => {
      const div = document.createElement('div');
      const isRev = revoked.includes(id);
      div.className = 'device ' + (isRev ? 'revoked' : 'active');
      div.innerHTML = `<div style="flex:1"><strong>${id}</strong><div class="note" style="margin-top:6px">${isRev ? 'Revoked' : 'Active'}</div></div>
                       <div style="display:flex;gap:8px">
                         <button onclick="manualRevoke('${id}')">${isRev ? 'Unrevoke' : 'Revoke'}</button>
                         <button onclick="manualDelete('${id}')">Delete</button>
                       </div>`;
      container.appendChild(div);
    });
  }

  // Expose small global helpers for the render buttons within created elements
  window.manualRevoke = function(id) {
    let arr = readRevokedLocal();
    if (arr.includes(id)) arr = arr.filter(x => x !== id);
    else arr.push(id);
    writeRevokedLocal(arr);
    renderDevices();
  };
  window.manualDelete = function(id) {
    // remove id from allDevices in localStorage (doesn't affect remote file)
    let list = readAllDevices();
    list = list.filter(x => x !== id);
    localStorage.setItem(ALL_DEVICES_KEY, JSON.stringify(list));
    // also remove from revoked
    let revoked = readRevokedLocal().filter(x => x !== id);
    writeRevokedLocal(revoked);
    renderDevices();
  };

  // initial render when admin opens UI
  // (if admin was already shown via auto-login, show devices)
  if (localStorage.getItem('isAdmin') === 'true') renderDevices();

})();
</script>
</body>
</html>
